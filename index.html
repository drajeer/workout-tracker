<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="icon" href="data:,">
  <title>TRACKER OS - FIXED DATA SYNC</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script async defer src="https://accounts.google.com/gsi/client"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
    :root { --bg: #ffffff; --screen: #f2f2f2; --mid: #e0e0e0; --deep: #000000; font-family: 'Inter', sans-serif; }
    body { background-color: var(--bg); color: var(--deep); overscroll-behavior-y: contain; }
    .ereader-panel { background-color: var(--screen); border: 1px solid var(--deep); border-radius: 4px; }
    .ereader-btn-outline { background-color: transparent; border: 4px solid var(--deep); color: var(--deep); text-transform: uppercase; font-weight: 900; transition: all 0.2s; }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; }
    .calendar-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; font-size: 8px; font-weight: 700; border: 1px solid rgba(0,0,0,0.05); background: white; }
    .day-mini-icon { width: 90%; height: 90%; object-fit: contain; image-rendering: pixelated; }
    ::-webkit-scrollbar { width: 0px; }
  </style>
</head>
<body class="p-4 flex justify-center">
  <div id="root" class="w-full max-w-md"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;

    const CLIENT_ID = '993686805304-ejcjgvg9or29fi8e7gsek1kqljob2hok.apps.googleusercontent.com';
    const SCOPES = 'https://www.googleapis.com/auth/drive.file';

    const storage = {
      data: JSON.parse(localStorage.getItem('workoutData') || '{}'),
      saveLocal() { localStorage.setItem('workoutData', JSON.stringify(this.data)); }
    };

    const workoutData = {
      1: { type: 'rounds', rounds: 3, warmUp: { name: '1km Run' }, exercises: [{ id: 1, name: '20m dumbbell lunges', trackWeight: true }, { id: 2, name: '20m sled push', trackWeight: true }, { id: 4, name: '15 goblet squats', trackWeight: true }, { id: 5, name: '15 box jumps' }, { id: 3, name: '500m rowing' }] },
      2: { type: 'sets', warmUp: { name: '1km Run' }, exercises: [{ id: 1, name: 'Leg press', sets: 4 }, { id: 2, name: 'Bench press', sets: 4 }, { id: 3, name: 'Cable row', sets: 4 }, { id: 4, name: 'Bulgarian split squats', sets: 3 }, { id: 5, name: 'Face pulls', sets: 3 }], finisher: { name: '15 min run' }},
      3: { type: 'rounds', rounds: 3, warmUp: { name: '1km Run' }, exercises: [{ id: 1, name: '10 pull-ups' }, { id: 2, name: '10 dips' }, { id: 3, name: '10 barbell thrusters', trackWeight: true }, { id: 4, name: '10m sled pull', trackWeight: true }, { id: 5, name: '15 push-ups' }, { id: 6, name: '500m rowing' }] },
      4: { type: 'sets', warmUp: { name: '1km Run' }, exercises: [{ id: 1, name: 'Leg curls', sets: 4 }, { id: 2, name: 'Overhead press', sets: 4 }, { id: 3, name: 'Lat pulldown', sets: 4 }, { id: 4, name: 'Incline dumbbell press', sets: 3 }, { id: 5, name: 'Cable triceps pushdowns', sets: 3 }, { id: 6, name: 'Dumbbell curls', sets: 3 }], finisher: { name: '15 min run' }}
    };

    function App() {
      const [isLoggedIn, setIsLoggedIn] = useState(false);
      const [tokenClient, setTokenClient] = useState(null);
      const [isActive, setIsActive] = useState(false);
      const [syncStatus, setSyncStatus] = useState("OFFLINE");
      const [trigger, setTrigger] = useState(0);

      // FIXED: Now correctly counts keys starting with "workout:"
      const totalSessions = useMemo(() => {
        return Object.keys(storage.data).filter(k => k.startsWith('workout:')).length;
      }, [storage.data, trigger]);

      const nextDayLabel = (totalSessions + 1).toString().padStart(2, '0');
      const currentRotationId = (totalSessions % 4) + 1;

      useEffect(() => {
        const init = () => {
          const client = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID, scope: SCOPES,
            callback: (resp) => {
              if (resp.access_token) {
                localStorage.setItem('gdrive_token', resp.access_token);
                setIsLoggedIn(true);
                loadCloudData(resp.access_token);
              }
            }
          });
          setTokenClient(client);
          const existingToken = localStorage.getItem('gdrive_token');
          if (existingToken) setIsLoggedIn(true);
        };
        const script = document.createElement('script');
        script.src = "https://accounts.google.com/gsi/client";
        script.onload = init;
        document.head.appendChild(script);
      }, []);

      const loadCloudData = async (token) => {
        setSyncStatus("PULLING...");
        try {
          const res = await fetch('https://www.googleapis.com/drive/v3/files?q=name="workouts.json" and trashed=false', {
            headers: { Authorization: `Bearer ${token}` }
          });
          const data = await res.json();
          if (data.files?.length > 0) {
            const fileRes = await fetch(`https://www.googleapis.com/drive/v3/files/${data.files[0].id}?alt=media`, {
              headers: { Authorization: `Bearer ${token}` }
            });
            storage.data = await fileRes.json();
            storage.saveLocal();
            setTrigger(t => t + 1);
            setSyncStatus("SYNCED");
          }
        } catch (e) { setSyncStatus("ERROR"); }
      };

      const syncToCloud = async () => {
        let token = localStorage.getItem('gdrive_token');
        if (!token) return;
        setSyncStatus("SAVING...");
        try {
          const listRes = await fetch('https://www.googleapis.com/drive/v3/files?q=name="workouts.json" and trashed=false', {
            headers: { Authorization: `Bearer ${token}` }
          });
          const listData = await listRes.json();
          const fileId = listData.files?.[0]?.id;
          const metadata = { name: 'workouts.json', mimeType: 'application/json' };
          const form = new FormData();
          form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
          form.append('file', new Blob([JSON.stringify(storage.data)], { type: 'application/json' }));
          
          await fetch(fileId ? `https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=multipart` : 'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
            method: fileId ? 'PATCH' : 'POST', headers: { Authorization: `Bearer ${token}` }, body: form
          });
          setSyncStatus("READY");
        } catch (e) { setSyncStatus("SAVE_ERROR"); }
      };

      if (!isLoggedIn) return (
        <div className="h-screen flex items-center justify-center bg-white p-6 border-8 border-double border-black">
          <button onClick={() => tokenClient.requestAccessToken()} className="ereader-btn-outline px-10 py-6 text-2xl">AUTH GOOGLE</button>
        </div>
      );

      return (
        <div className="ereader-panel p-8 min-h-[90vh] flex flex-col w-full shadow-sm">
          {!isActive ? (
            <div className="flex-1 flex flex-col">
              <div className="border-b-2 border-black pb-2 mb-10 flex justify-between items-end">
                <h1 className="text-xl font-black uppercase tracking-widest">TRACKER</h1>
                <div className="flex gap-2 items-center">
                   <button onClick={() => loadCloudData(localStorage.getItem('gdrive_token'))} className="text-[8px] border border-black px-1 font-bold">FORCE PULL</button>
                   <span className="text-[10px] font-bold opacity-30">{syncStatus}</span>
                </div>
              </div>
              <div className="flex-1 flex flex-col justify-center items-center">
                <button onClick={() => setIsActive(true)} className="ereader-btn-outline w-full py-16 text-4xl">START: DAY {nextDayLabel}</button>
              </div>
              <WorkoutCalendar trigger={trigger} storage={storage} />
            </div>
          ) : (
            <GuidedSession rotationId={currentRotationId} dayLabel={nextDayLabel} onBack={() => { setIsActive(false); setTrigger(t => t + 1) }} storage={storage} onSync={syncToCloud} />
          )}
        </div>
      );
    }

    function WorkoutCalendar({ trigger, storage }) {
      const [viewDate, setViewDate] = useState(new Date());
      const sessionMap = useMemo(() => {
        const map = {};
        Object.values(storage.data).forEach(val => {
          // FIXED: Parse the internal JSON string found in your file
          const entry = typeof val === 'string' ? JSON.parse(val) : val;
          const dString = new Date(entry.date).toDateString();
          map[dString] = entry.day; // Map to the "Day X" field
        });
        return map;
      }, [storage.data, trigger]);

      const daysInMonth = new Date(viewDate.getFullYear(), viewDate.getMonth() + 1, 0).getDate();
      const firstDayOfMonth = new Date(viewDate.getFullYear(), viewDate.getMonth(), 1).getDay();
      const days = [];
      for (let i = 0; i < firstDayOfMonth; i++) days.push(<div key={`pad-${i}`} className="calendar-day opacity-0" />);
      for (let d = 1; d <= daysInMonth; d++) {
        const dateObj = new Date(viewDate.getFullYear(), viewDate.getMonth(), d);
        const hasWorkout = sessionMap[dateObj.toDateString()];
        days.push(
          <div key={d} className="calendar-day">
            {hasWorkout ? (
              <img src={`file:///Users/ashajeer/Library/CloudStorage/GoogleDrive-mrajeer@gmail.com/My%20Drive/WorkoutApp/DAY%20ICONS/DAY%2001@3x.png`} className="day-mini-icon" />
            ) : ( <span className="opacity-10">{d}</span> )}
          </div>
        );
      }
      return (
        <div className="mt-auto border-t-2 border-black pt-6">
          <div className="flex justify-between items-center mb-4 uppercase font-black text-[11px]">
            <button onClick={() => setViewDate(new Date(viewDate.getFullYear(), viewDate.getMonth() - 1, 1))}>&lt;</button>
            <span>{viewDate.toLocaleString('default', { month: 'long' })}</span>
            <button onClick={() => setViewDate(new Date(viewDate.getFullYear(), viewDate.getMonth() + 1, 1))}>&gt;</button>
          </div>
          <div className="calendar-grid">{days}</div>
        </div>
      );
    }

    // GuidedSession component logic remains the same
    function GuidedSession({ rotationId, onBack, storage, dayLabel, onSync }) {
      const config = workoutData[rotationId];
      const [step, setStep] = useState('warmup');
      const [timer, setTimer] = useState(0);
      const [activeExId, setActiveExId] = useState(null);
      const [progress, setProgress] = useState(config.exercises.reduce((acc, ex) => {
        acc[ex.id] = config.type === 'rounds' ? 0 : [];
        return acc;
      }, {}));
      useEffect(() => { const interval = setInterval(() => setTimer(t => t + 1), 1000); return () => clearInterval(interval); }, []);
      const activeEx = config.exercises.find(e => e.id === activeExId);
      const logAttempt = (status) => {
        const next = config.type === 'rounds' ? progress[activeExId] + 1 : [...progress[activeExId], status];
        setProgress({ ...progress, [activeExId]: next });
        if (config.type === 'rounds' ? next >= config.rounds : next.length >= activeEx.sets) setActiveExId(null);
      };
      return (
        <div className="flex flex-col gap-6 flex-1">
          <div className="flex justify-between items-center text-[10px] font-bold border-b border-black pb-2 uppercase tracking-widest">
            <span>D{dayLabel} // S{rotationId}</span>
            <button onClick={onBack} className="underline">Abort</button>
          </div>
          {step === 'warmup' && (
            <div className="flex-1 flex flex-col justify-center gap-8 text-center">
              <h2 className="text-4xl font-black uppercase italic">Warm Up</h2>
              <div className="border-4 border-black p-8 bg-white uppercase font-black text-xl">{config.warmUp.name}</div>
              <button onClick={() => setStep('hub')} className="ereader-btn-outline px-6 py-4">Enter Hub</button>
            </div>
          )}
          {step === 'hub' && !activeExId && (
            <div className="flex-1 flex flex-col gap-4">
              <div className="space-y-3">
                {config.exercises.map(ex => (
                  <button key={ex.id} onClick={() => setActiveExId(ex.id)} className="w-full text-left bg-white p-3 border-2 border-black">
                    <div className="flex justify-between font-black uppercase text-[10px] mb-2"><span>{ex.name}</span></div>
                    <div className="flex gap-1">
                      {Array.from({ length: config.type === 'rounds' ? config.rounds : ex.sets }).map((_, i) => {
                        const s = config.type === 'rounds' ? (i < progress[ex.id]) : progress[ex.id][i];
                        return <div key={i} className={`h-2 flex-1 border border-black ${s ? 'bg-black' : ''}`} />;
                      })}
                    </div>
                  </button>
                ))}
              </div>
              <button onClick={() => {
                storage.data[`workout:${Date.now()}`] = JSON.stringify({ date: new Date().toISOString(), dayLabel, day: `Day ${rotationId}` });
                storage.saveLocal(); onSync(); onBack();
              }} className="ereader-btn-deep py-6 mt-auto">STAMP DAY {dayLabel}</button>
            </div>
          )}
          {step === 'hub' && activeExId && (
            <div className="flex-1 flex flex-col gap-8 text-center pt-10">
              <h2 className="text-2xl font-black uppercase italic">{activeEx.name}</h2>
              <div className="flex-1 flex flex-col justify-center border-y-4 border-black bg-white font-black py-12"><p className="text-4xl uppercase">Log Result</p></div>
              <div className="grid grid-cols-2 gap-4"><button onClick={() => logAttempt('failed')} className="border-4 border-black font-black uppercase py-4 text-xs">Failed</button><button onClick={() => logAttempt('success')} className="ereader-btn-deep py-4 text-xl">Success</button></div>
            </div>
          )}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
